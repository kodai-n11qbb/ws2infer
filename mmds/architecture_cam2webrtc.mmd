flowchart TD
  subgraph "Sender (配信者)"
    S[getUserMedia<br/>カメラ/マイク取得]
    PC_MGR["Connection Manager<br/>(Viewer毎にPC生成: Mesh方式)"]
  end
  
  subgraph "Rust Signaling Server"
    WS[WebSocket Server]
    ROOM[Room管理]
    
    STUN["内蔵STUN Server<br/>UDP:3478"]
    TURN["内蔵TURN Server<br/>UDP:3479"]
  end
  
  subgraph "Viewers (視聴者)"
    V1[Viewer 1]
    V2[Viewer 2]
    VN[Viewer N]
  end

  %% ストリームの流れ
  S --> PC_MGR

  %% Signaling Flow
  PC_MGR <-->|"WebSocket: Signaling<br/>(Join/Offer/Answer/Ice)"| WS
  WS <-->|WebSocket: Signaling| V1
  WS <-->|WebSocket: Signaling| V2
  WS <-->|WebSocket: Signaling| VN
  
  %% Server Logic
  WS --- ROOM
  
  %% ICE/STUN/TURN Flow (Clients connect directly via UDP)
  PC_MGR -.->|UDP: ICE Check| STUN
  V1 -.->|UDP: ICE Check| STUN
  V2 -.->|UDP: ICE Check| STUN
  
  PC_MGR -.->|"UDP: Relay (if needed)"| TURN
  V1 -.->|"UDP: Relay (if needed)"| TURN
  V2 -.->|"UDP: Relay (if needed)"| TURN
  
  %% P2P Data Flow (Mesh)
  PC_MGR <==>|WebRTC: P2P Stream| V1
  PC_MGR <==>|WebRTC: P2P Stream| V2
  PC_MGR <==>|WebRTC: P2P Stream| VN

